name: Release Extension

on:
  push:
    tags:
      - 'v*'
      - '*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install tools
        run: npm install -g web-ext

      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      # ---------------- Chrome Build ----------------
      - name: Build Chrome Artifacts
        run: |
          # Prepare source for Chrome
          cp -r src src-chrome
          
          # Use Chrome manifest
          cp src-chrome/manifest_chrome.json src-chrome/manifest.json
          
          # Rename worker
          mv src-chrome/js/worker-chrome.js src-chrome/js/worker.js
          
          # Remove extra manifest files
          rm src-chrome/manifest_chrome.json src-chrome/manifest_firefox.json src-chrome/js/worker-firefox.js
          
          # Build ZIP
          cd src-chrome
          zip -r ../ProxyAssistant_${{ steps.get_version.outputs.VERSION }}_chrome.zip .
          cd ..
          
          # Build TAR.GZ
          tar -czvf ProxyAssistant_${{ steps.get_version.outputs.VERSION }}_chrome.tar.gz -C src-chrome .
          
          # Cleanup
          rm -rf src-chrome

      # ---------------- Firefox Build ----------------
      - name: Build Firefox Artifacts
        run: |
          # Prepare source for Firefox
          cp -r src src-firefox
          
          # Use Firefox manifest
          cp src-firefox/manifest_firefox.json src-firefox/manifest.json
          
          # Rename worker
          mv src-firefox/js/worker-firefox.js src-firefox/js/worker.js
          
          # Remove extra manifest files
          rm src-firefox/manifest_chrome.json src-firefox/manifest_firefox.json src-firefox/js/worker-chrome.js
          
          # Build ZIP (for manual install/review)
          cd src-firefox
          zip -r ../ProxyAssistant_${{ steps.get_version.outputs.VERSION }}_firefox.zip .
          cd ..
          
          # Build TAR.GZ
          tar -czvf ProxyAssistant_${{ steps.get_version.outputs.VERSION }}_firefox.tar.gz -C src-firefox .
          
          # Build XPI using web-ext
          web-ext build --source-dir src-firefox --artifacts-dir dist --overwrite-dest
          
          # Rename generated zip to xpi
          FILE=$(ls dist/*.zip)
          mv "$FILE" ProxyAssistant_${{ steps.get_version.outputs.VERSION }}_firefox.xpi
          
          # Cleanup
          rm -rf src-firefox

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ProxyAssistant_${{ steps.get_version.outputs.VERSION }}_chrome.zip
            ProxyAssistant_${{ steps.get_version.outputs.VERSION }}_chrome.tar.gz
            ProxyAssistant_${{ steps.get_version.outputs.VERSION }}_firefox.zip
            ProxyAssistant_${{ steps.get_version.outputs.VERSION }}_firefox.tar.gz
            ProxyAssistant_${{ steps.get_version.outputs.VERSION }}_firefox.xpi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
