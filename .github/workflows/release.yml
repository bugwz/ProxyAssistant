name: Release Extension

on:
  push:
    tags:
      - 'v*'
      - '*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install tools
        run: npm install -g web-ext

      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build ZIP
        # Zip the src directory
        run: zip -r ProxyAssistant_${{ steps.get_version.outputs.VERSION }}.zip src

      - name: Build TAR.GZ
        # Tar.gz the src directory
        run: tar -czvf ProxyAssistant_${{ steps.get_version.outputs.VERSION }}.tar.gz src

      - name: Build Firefox XPI
        run: |
          # Copy src to a temporary directory for modification
          cp -r src src-firefox

          # Modify manifest.json for Firefox compatibility (use background.scripts instead of service_worker)
          node -e "
            const fs = require('fs');
            const manifestPath = 'src-firefox/manifest.json';
            if (fs.existsSync(manifestPath)) {
              const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
              if (manifest.background && manifest.background.service_worker) {
                const sw = manifest.background.service_worker;
                delete manifest.background.service_worker;
                manifest.background.scripts = [sw];
              }
              if (manifest.key) {
                delete manifest.key;
              }
              fs.writeFileSync(manifestPath, JSON.stringify(manifest, null, 2));
            }
          "

          # Build with web-ext, specifying src-firefox as source directory
          web-ext build --source-dir src-firefox --artifacts-dir dist --overwrite-dest
          # web-ext generates a zip file by default, rename it to xpi
          # Find the generated zip file (usually only one)
          FILE=$(ls dist/*.zip)
          mv "$FILE" ProxyAssistant_${{ steps.get_version.outputs.VERSION }}_firefox.xpi

          # Cleanup
          rm -rf src-firefox

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ProxyAssistant_${{ steps.get_version.outputs.VERSION }}.zip
            ProxyAssistant_${{ steps.get_version.outputs.VERSION }}.tar.gz
            ProxyAssistant_${{ steps.get_version.outputs.VERSION }}_firefox.xpi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
